<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:ui="http://schemas.microsoft.com/wix/UIExtension">
  
  <Product Id="*" Name="Browser Redirector" Language="1033" Version="1.0.0" 
           Manufacturer="BrowserRedirector" UpgradeCode="B72CD137-77D1-4D63-A1E4-DD3D06AE6A79">
    
    
    <!-- Architecture-specific package settings -->
    
    <!-- 64-bit Installer -->
    <?ifdef IsX64 ?>
      <?if $(var.IsX64) = "yes" ?>
        <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Platform="x64" />
      <?endif?>
    <?endif?>

    <!-- 32-bit Installer -->
    <?ifdef IsX86 ?>
      <?if $(var.IsX86) = "yes" ?>
        <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Platform="x86" />
      <?endif?>
    <?endif?>

    <!-- ARM64 Installer -->
    <?ifdef IsARM64 ?>
      <?if $(var.IsARM64) = "yes" ?>
        <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Platform="arm64" />
      <?endif?>
    <?endif?>

    <!-- Fallback if no architecture is defined -->
    <?ifndef IsX64 ?>
    <?ifndef IsX86 ?>
    <?ifndef IsARM64 ?>
        <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />
    <?endif?>
    <?endif?>
    <?endif?>
    
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <MediaTemplate EmbedCab="yes" />
    
    <!-- Define application icon with index 0 -->
    <Icon Id="BrowserRedirectorIcon" SourceFile="BrowserRedirector.exe" />
    
    <!-- UI Configuration -->
    <UI Id="WixUI_BrowserRedirector">
      <UIRef Id="WixUI_InstallDir" />
      <UIRef Id="WixUI_ErrorProgressText" />
      
      <!-- Define custom dialogs -->
      <Dialog Id="UserSettingsDialog" Width="370" Height="270" Title="Installation Options">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="Installation Options" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Choose your installation preferences" />
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        
        <!-- Options section -->
        <Control Id="OptionsLabel" Type="Text" X="20" Y="60" Width="290" Height="15" Text="Select your preferences:" />
        <Control Id="RegisterBrowserCheckbox" Type="CheckBox" X="20" Y="80" Width="330" Height="17" Property="REGISTER_BROWSER" CheckBoxValue="1" Text="Register as a browser option in Windows" />
        <Control Id="ExplanationText" Type="Text" X="20" Y="100" Width="330" Height="40" Text="This will allow Browser Redirector to be selectable as a default browser option in Windows settings. The application will handle URLs based on your defined patterns." />
        
        <!-- Navigation buttons -->
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back" />
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next" />
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>
      
      <Dialog Id="UserUninstallDialog" Width="370" Height="270" Title="Uninstall Options">
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="Uninstall Options" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="Choose what to remove during uninstallation" />
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        
        <!-- Uninstall options section -->
        <Control Id="OptionsLabel" Type="Text" X="20" Y="60" Width="290" Height="15" Text="Select items to remove:" />
        <Control Id="RemoveAppDataCheckbox" Type="CheckBox" X="20" Y="80" Width="330" Height="17" Property="REMOVE_APP_DATA" CheckBoxValue="1" Text="Remove application data (settings, configurations)" />
        <Control Id="ExplanationText" Type="Text" X="20" Y="100" Width="330" Height="40" Text="If unchecked, your settings will be left on your computer. You may want to keep your settings if you plan to reinstall the application later." />
        
        <!-- Navigation buttons -->
        <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="&amp;Back" />
        <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="&amp;Next" />
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="Cancel">
          <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
        </Control>
      </Dialog>
      
      <!-- Complete UI sequence customization - only modify what we're adding -->
      <!-- Just modify the InstallDirDlg to point to our custom dialog -->
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="UserSettingsDialog">WIXUI_DONTVALIDATEPATH OR WIXUI_INSTALLDIR_VALID="1"</Publish>
      
      <!-- UserSettingsDialog sequencing -->
      <Publish Dialog="UserSettingsDialog" Control="Back" Event="NewDialog" Value="InstallDirDlg">1</Publish>
      <Publish Dialog="UserSettingsDialog" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
      
      <!-- Ensure VerifyReadyDlg goes back to our custom dialogs -->
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="UserSettingsDialog">NOT Installed AND NOT PATCH</Publish>
      
      <!-- Maintenance mode flow - only customize the RemoveButton path -->
      <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="UserUninstallDialog">1</Publish>
      
      <!-- UserUninstallDialog sequencing -->
      <Publish Dialog="UserUninstallDialog" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>
      <Publish Dialog="UserUninstallDialog" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
      
      <!-- Ensure VerifyReadyDlg for uninstall goes back to UserUninstallDialog -->
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="UserUninstallDialog">Installed AND REMOVE="ALL"</Publish>
    </UI>
    
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="REMOVE_APP_DATA" Value="1" />
    <Property Id="REGISTER_BROWSER" Value="1" />
    
    <!-- Set icon properties -->
    <Property Id="ARPPRODUCTICON" Value="BrowserRedirectorIcon" />
    <Property Id="ARPNOREPAIR" Value="1" />
    
    <Feature Id="ProductFeature" Title="Browser Redirector" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="RegistryEntries" />
      <ComponentRef Id="StartMenuShortcut" />
      <ComponentRef Id="RemoveProgramMenuDir" />
      <ComponentRef Id="RemoveInstallFolder" />
      <ComponentRef Id="RegisteredApp" />
      <ComponentRef Id="BrowserMainRegistry" />
      <ComponentRef Id="BrowserHTMLProgID" />
      <ComponentRef Id="BrowserURLProgID" />
      <ComponentRef Id="CleanupRegistryKey" />
      <ComponentRef Id="CleanupHKCURegistryKey" />
    </Feature>
    
    <!-- Define conditional feature for removal of app data -->
    <Feature Id="RemoveAppDataFeature" Title="Remove Application Data" Level="0" Display="hidden">
      <Condition Level="1">REMOVE_APP_DATA = 1 AND Installed AND REMOVE = "ALL"</Condition>
      <ComponentRef Id="CleanupAppData" />
    </Feature>
    
  <Directory Id="TARGETDIR" Name="SourceDir">
    <!-- x64 Installer (Installs to Program Files) -->
    <?ifdef IsX64 ?>
    <?if $(var.IsX64) = "yes" ?>
    <Directory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Browser Redirector" />
    </Directory>
    <?endif?>
    <?endif?>

    <!-- x86 Installer (Installs to Program Files (x86) on x64, otherwise Program Files) -->
    <?ifdef IsX86 ?>
    <?if $(var.IsX86) = "yes" ?>
    <Directory Id="ProgramFilesFolder">
      <Directory Id="INSTALLFOLDER" Name="Browser Redirector" />
    </Directory>
    <?endif?>
    <?endif?>

    <!-- ARM64 Installer (Installs to Program Files) -->
    <?ifdef IsARM64 ?>
    <?if $(var.IsARM64) = "yes" ?>
    <Directory Id="ProgramFilesFolder">
      <Directory Id="INSTALLFOLDER" Name="Browser Redirector" />
    </Directory>
    <?endif?>
    <?endif?>

    <Directory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Browser Redirector" />
    </Directory>

    <Directory Id="LocalAppDataFolder">
      <Directory Id="AppDataCompanyFolder" Name="BrowserRedirector">
        <Directory Id="AppDataFolder" Name="Data" />
      </Directory>
    </Directory>
  </Directory>
    
    <!-- Start Menu Shortcut with proper folder removal -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="StartMenuShortcut" Guid="*" Win64="$(var.IsX64)">
        <Shortcut Id="ApplicationStartMenuShortcut" 
                  Name="Browser Redirector" 
                  Description="Launch Browser Redirector"
                  Target="[INSTALLFOLDER]BrowserRedirector.exe"
                  WorkingDirectory="INSTALLFOLDER" />
        <RemoveFile Id="RemoveShortcutFiles" Name="*.*" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RemoveFolder Id="RemoveAppFolder" Directory="ApplicationProgramsFolder" On="both" />
        <RegistryValue Root="HKCU" Key="Software\BrowserRedirector" Name="StartMenuInstalled" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>
    
    <!-- Handle ProgramMenuFolder explicit removal -->
    <DirectoryRef Id="ProgramMenuFolder">
      <Component Id="RemoveProgramMenuDir" Guid="*" Win64="$(var.IsX64)">
        <RemoveFolder Id="ProgramMenuFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\BrowserRedirector" Name="ProgramsMenuRemoved" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>
    
    <!-- DirectoryRef for INSTALLFOLDER to ensure cleanup -->
    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="RemoveInstallFolder" Guid="*" Win64="$(var.IsX64)">
        <RemoveFile Id="RemoveAllFiles" Name="*.*" On="uninstall" />
        <RemoveFolder Id="INSTALLFOLDER" On="uninstall" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\BrowserRedirector" Name="InstallFolderRemoved" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>
    
    <!-- Component to handle cleanup of AppData folder -->
    <DirectoryRef Id="AppDataCompanyFolder">
      <Component Id="CleanupAppData" Guid="*">
        <!-- AppData cleanup: remove application data folders during uninstall -->
        <RemoveFolder Id="CleanupAppDataFolder" Directory="AppDataFolder" On="uninstall" />
        <RemoveFolder Id="CleanupAppDataCompanyFolder" Directory="AppDataCompanyFolder" On="uninstall" />
        <!-- Registry key used as KeyPath for this component -->
        <RegistryValue Root="HKCU" Key="Software\BrowserRedirector" Name="AppDataCleaned" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>
    
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- Add all your application files here -->
      <Component Id="MainExecutable" Guid="*" Win64="$(var.IsX64)">
        <File Id="BrowserRedirectorEXE" Source="BrowserRedirector.exe" KeyPath="yes" />
      </Component>
      
      <!-- Add other files here as needed -->
    </ComponentGroup>
    
    <ComponentGroup Id="RegistryEntries">
      <!-- Main Browser Registration for StartMenuInternet Root -->
      <!-- This component is specifically for cleaning up the main registry key -->
      <Component Id="CleanupRegistryKey" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector" Action="removeOnUninstall" />
        <RemoveRegistryKey Root="HKLM" Key="SOFTWARE\BrowserRedirector" Action="removeOnUninstall" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\BrowserRedirector\Cleanup" Name="CleanupRegistryKey" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      
      <!-- Clean up HKCU registry keys -->
      <Component Id="CleanupHKCURegistryKey" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <RemoveRegistryKey Root="HKCU" Key="Software\BrowserRedirector" Action="removeOnUninstall" />
        <RegistryValue Root="HKCU" Key="Software\BrowserRedirector\Cleanup" Name="CleanupRegistryKeyHKCU" Type="integer" Value="1" KeyPath="yes" />
      </Component>

      <Component Id="BrowserMainRegistry" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <Condition>REGISTER_BROWSER = 1</Condition>
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector" Type="string" Value="Browser Redirector" KeyPath="yes" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector" Name="LocalizedString" Type="string" Value="Browser Redirector" />
      </Component>

      <!-- Browser Registration Additional Entries -->
      <Component Id="BrowserRegistration" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <Condition>REGISTER_BROWSER = 1</Condition>
        
        <!-- Icon registration -->
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\DefaultIcon" 
                       Type="string" Value="[INSTALLFOLDER]BrowserRedirector.exe,0" KeyPath="yes" />
        
        <!-- Command registration -->
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\shell\open\command" 
                       Type="string" Value="&quot;[INSTALLFOLDER]BrowserRedirector.exe&quot; &quot;%1&quot;" />
        
        <!-- Capabilities registration -->
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities"
                       Name="ApplicationName" Type="string" Value="Browser Redirector" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities"
                       Name="ApplicationDescription" Type="string" Value="A tool to redirect URLs to specific browsers based on regex patterns" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities"
                       Name="ApplicationIcon" Type="string" Value="[INSTALLFOLDER]BrowserRedirector.exe,0" />
        
        <!-- URL Associations -->
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities\URLAssociations"
                       Name="http" Type="string" Value="BrowserRedirectorURL" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities\URLAssociations"
                       Name="https" Type="string" Value="BrowserRedirectorURL" />
        
        <!-- File Associations (for HTML files) -->
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities\FileAssociations"
                       Name=".htm" Type="string" Value="BrowserRedirectorHTML" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities\FileAssociations"
                       Name=".html" Type="string" Value="BrowserRedirectorHTML" />
      </Component>
      
      <!-- ProgID for HTML files -->
      <Component Id="BrowserHTMLProgID" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <Condition>REGISTER_BROWSER = 1</Condition>
        <RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorHTML" Action="removeOnUninstall" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorHTML"
                       Type="string" Value="Browser Redirector HTML Document" KeyPath="yes" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorHTML"
                       Name="FriendlyTypeName" Type="string" Value="Browser Redirector HTML Document" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorHTML\shell\open\command"
                       Type="string" Value="&quot;[INSTALLFOLDER]BrowserRedirector.exe&quot; &quot;%1&quot;" />
      </Component>
      
      <!-- ProgID for URLs -->
      <Component Id="BrowserURLProgID" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <Condition>REGISTER_BROWSER = 1</Condition>
        <RemoveRegistryKey Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorURL" Action="removeOnUninstall" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorURL"
                       Type="string" Value="Browser Redirector URL" KeyPath="yes" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorURL"
                       Name="FriendlyTypeName" Type="string" Value="Browser Redirector URL" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorURL"
                       Name="URL Protocol" Type="string" Value="" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorURL"
                       Name="EditFlags" Type="integer" Value="2" />
        <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\BrowserRedirectorURL\shell\open\command"
                       Type="string" Value="&quot;[INSTALLFOLDER]BrowserRedirector.exe&quot; &quot;%1&quot;" />
      </Component>
      
      <!-- Specific component for RegisteredApplications entry for easier removal -->
      <Component Id="RegisteredApp" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <Condition>REGISTER_BROWSER = 1</Condition>
        <RegistryValue Root="HKLM" Key="SOFTWARE\RegisteredApplications" 
                      Name="BrowserRedirector" 
                      Type="string" 
                      Value="SOFTWARE\Clients\StartMenuInternet\BrowserRedirector\Capabilities" 
                      KeyPath="yes" />
        <!-- This component's sole purpose is to register/unregister with default programs -->
      </Component>
      
      <!-- Base Registry Component - always installed even if browser registration is disabled -->
      <Component Id="BaseRegistry" Guid="*" Directory="INSTALLFOLDER" Win64="$(var.IsX64)">
        <RegistryKey Root="HKLM" Key="SOFTWARE\BrowserRedirector">
          <RegistryValue Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" KeyPath="yes" />
          <RegistryValue Name="Version" Type="string" Value="1.0.0" />
        </RegistryKey>
      </Component>
    </ComponentGroup>
  </Product>
</Wix>